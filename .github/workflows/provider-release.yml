name: provider | Terraform Provider Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_version:
        description: 'TF Provider Release version to publish. Requires an pre-existing repo release and the provided value must be formatted as a semver.'
        required: true
        default: 'v0.0.0-alpha'


permissions:
  contents: write
  id-token: write
  packages: read
  statuses: write

jobs:
  pre-release-checks:
    name: 'ðŸš¦ Pre-release Validation'
    runs-on: ubuntu-22.04-arm-4c-l
    timeout-minutes: 120
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
      with:
        egress-policy: audit

    - name: Check out code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0
        ref: ${{ github.event.inputs.release_version || github.ref }}

    - name: Set up Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        cache: true
        cache-dependency-path: 'go.sum'
        go-version-file: 'go.mod'
      id: go

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3.1.2
      with:
        terraform_version: '1.10.2'
        terraform_wrapper: false

    - name: Run 'go mod tidy' and check for differences
      run: |
        go mod tidy
        git diff --exit-code -- go.mod go.sum || \
        (echo; echo "Unexpected difference in go.mod/go.sum files. Run 'go mod tidy' command or revert any go.mod/go.sum changes and commit."; exit 1)

    - name: Get go mod dependencies
      run: |
        go mod download

    - name: Go build
      run: |
        go build -v .
      env:
        CGO_ENABLED: 0
        GOMAXPROCS: 4

  # Release for Partner and Community Providers
  # https://goreleaser.com/cmd/goreleaser_release/#see-also
  terraform-provider-release:
    name: 'ðŸ“¦ Terraform Provider Release'
    needs: [pre-release-checks]
    uses:  ./.github/workflows/tf-registry-goreleaser.yml
    secrets:
      gpg-private-key: '${{ secrets.GPG_PRIVATE_KEY }}'  # Your GPG private key
      gpg-private-key-passphrase: '${{ secrets.GPG_PRIVATE_KEY_PASSPHRASE }}'  # Passphrase for your GPG key, if applicable
    with:
      goreleaser-release-args: --verbose --parallelism 1 --timeout 120m0s # parallelism set to match the number of free cores on the runner

      release-notes: false
      setup-go-version-file: 'go.mod'
      git-ref: ${{ github.event.inputs.release_version || github.ref }}

  release-notes:
    runs-on: ubuntu-latest
    needs: [terraform-provider-release]
    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit
          
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
      - name: Generate Release Notes
        run: sed -n -e "1{/# /d;}" -e "2{/^$/d;}" -e "/# $(git describe --abbrev=0 --exclude="$(git describe --abbrev=0 --match='v*.*.*' --tags)" --match='v*.*.*' --tags | tr -d v)/q;p" CHANGELOG.md > release-notes.txt
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: release-notes
          path: release-notes.txt
          retention-days: 1
