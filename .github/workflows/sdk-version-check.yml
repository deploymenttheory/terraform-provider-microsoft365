name: provider | Microsoft Graph Go SDK Version Check

on:
  schedule:
    # Run weekly on Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      sdk:
        description: 'Which SDK to check (all, msgraph, msgraph-beta)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - msgraph
          - msgraph-beta

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  detect-versions:
    name: Detect SDK Versions
    runs-on: ubuntu-latest
    outputs:
      current-msgraph-sdk: ${{ steps.detect.outputs.current-msgraph-sdk }}
      current-msgraph-beta-sdk: ${{ steps.detect.outputs.current-msgraph-beta-sdk }}
      latest-msgraph-sdk: ${{ steps.detect.outputs.latest-msgraph-sdk }}
      latest-msgraph-beta-sdk: ${{ steps.detect.outputs.latest-msgraph-beta-sdk }}
      has-updates: ${{ steps.detect.outputs.has-updates }}
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
      
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'
      
      - name: Detect versions
        id: detect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/pipeline/sdk_diff/steps/detect_versions.py \
            --repo-path . \
            --output-file $GITHUB_OUTPUT

  analyze-msgraph-sdk:
    name: Analyze msgraph-sdk-go
    needs: detect-versions
    if: |
      needs.detect-versions.outputs.has-updates == 'true' &&
      (github.event.inputs.sdk == 'all' || github.event.inputs.sdk == 'msgraph')
    runs-on: ubuntu-latest
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
      
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'
      
      - name: Map SDK usage
        id: usage
        run: |
          python3 scripts/pipeline/sdk_diff/steps/map_usage.py \
            --repo-path . \
            --output-file $GITHUB_OUTPUT \
            --usage-output sdk_usage_msgraph.json
      
      - name: Analyze changes
        id: analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/pipeline/sdk_diff/steps/analyze_changes.py \
            --usage-file sdk_usage_msgraph.json \
            --sdk msgraph-sdk-go \
            --current-version ${{ needs.detect-versions.outputs.current-msgraph-sdk }} \
            --latest-version ${{ needs.detect-versions.outputs.latest-msgraph-sdk }} \
            --output-file $GITHUB_OUTPUT \
            --changes-output sdk_changes_msgraph.json
      
      - name: Generate reports
        run: |
          mkdir -p sdk-diff-msgraph
          python3 scripts/pipeline/sdk_diff/steps/generate_report.py \
            --changes-file sdk_changes_msgraph.json \
            --usage-file sdk_usage_msgraph.json \
            --output-dir sdk-diff-msgraph
      
      - name: Upload reports as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sdk-diff-msgraph
          path: sdk-diff-msgraph/
      
      - name: Create issue if breaking changes found
        if: steps.analyze.outputs.has-breaking-changes == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('sdk-diff-msgraph/02_breaking_changes.md', 'utf8');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Breaking Changes in msgraph-sdk-go ${{ needs.detect-versions.outputs.latest-msgraph-sdk }}',
              body: report,
              labels: ['dependencies', 'breaking-change', 'sdk-upgrade']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  analyze-msgraph-beta-sdk:
    name: Analyze msgraph-beta-sdk-go
    needs: detect-versions
    if: |
      needs.detect-versions.outputs.has-updates == 'true' &&
      (github.event.inputs.sdk == 'all' || github.event.inputs.sdk == 'msgraph-beta')
    runs-on: ubuntu-latest
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
      
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'
      
      - name: Map SDK usage
        id: usage
        run: |
          python3 scripts/pipeline/sdk_diff/steps/map_usage.py \
            --repo-path . \
            --output-file $GITHUB_OUTPUT \
            --usage-output sdk_usage_msgraph_beta.json
      
      - name: Analyze changes
        id: analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/pipeline/sdk_diff/steps/analyze_changes.py \
            --usage-file sdk_usage_msgraph_beta.json \
            --sdk msgraph-beta-sdk-go \
            --current-version ${{ needs.detect-versions.outputs.current-msgraph-beta-sdk }} \
            --latest-version ${{ needs.detect-versions.outputs.latest-msgraph-beta-sdk }} \
            --output-file $GITHUB_OUTPUT \
            --changes-output sdk_changes_msgraph_beta.json
      
      - name: Generate reports
        run: |
          mkdir -p sdk-diff-msgraph-beta
          python3 scripts/pipeline/sdk_diff/steps/generate_report.py \
            --changes-file sdk_changes_msgraph_beta.json \
            --usage-file sdk_usage_msgraph_beta.json \
            --output-dir sdk-diff-msgraph-beta
      
      - name: Upload reports as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sdk-diff-msgraph-beta
          path: sdk-diff-msgraph-beta/
      
      - name: Create issue if breaking changes found
        if: steps.analyze.outputs.has-breaking-changes == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('sdk-diff-msgraph-beta/02_breaking_changes.md', 'utf8');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Breaking Changes in msgraph-beta-sdk-go ${{ needs.detect-versions.outputs.latest-msgraph-beta-sdk }}',
              body: report,
              labels: ['dependencies', 'breaking-change', 'sdk-upgrade']
            });
            
            console.log(`Created issue #${issue.data.number}`);
