name: OpenAPI Schema Detection

on:
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  
  workflow_dispatch:
    inputs:
      old_commit:
        description: 'Previous commit SHA from msgraph-metadata repo'
        required: false
        type: string
      new_commit:
        description: 'New commit SHA from msgraph-metadata repo (leave empty for latest)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (do not create issues)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  detect-openapi-changes:
    name: 'Detect OpenAPI Schema Changes'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check Out
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install pyyaml requests

      - name: Get latest commit SHA from msgraph-metadata
        id: get-commits
        run: |
          # Get latest commit SHA for openapi.yaml
          LATEST_COMMIT=$(curl -s \
            "https://api.github.com/repos/microsoftgraph/msgraph-metadata/commits?path=openapi/beta/openapi.yaml&per_page=1" \
            | jq -r '.[0].sha')
          
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "Latest commit: $LATEST_COMMIT"
          
          # Get commit from 7 days ago as baseline
          WEEK_AGO=$(date -u -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u -v-7d '+%Y-%m-%dT%H:%M:%SZ')
          BASELINE_COMMIT=$(curl -s \
            "https://api.github.com/repos/microsoftgraph/msgraph-metadata/commits?path=openapi/beta/openapi.yaml&until=$WEEK_AGO&per_page=1" \
            | jq -r '.[0].sha')
          
          echo "baseline_commit=$BASELINE_COMMIT" >> $GITHUB_OUTPUT
          echo "Baseline commit (7 days ago): $BASELINE_COMMIT"

      - name: Determine commit SHAs to compare
        id: commits
        run: |
          # Use workflow inputs if provided, otherwise use automatic detection
          if [ -n "${{ inputs.old_commit }}" ]; then
            OLD_COMMIT="${{ inputs.old_commit }}"
          else
            OLD_COMMIT="${{ steps.get-commits.outputs.baseline_commit }}"
          fi
          
          if [ -n "${{ inputs.new_commit }}" ]; then
            NEW_COMMIT="${{ inputs.new_commit }}"
          else
            NEW_COMMIT="${{ steps.get-commits.outputs.latest_commit }}"
          fi
          
          echo "old_commit=$OLD_COMMIT" >> $GITHUB_OUTPUT
          echo "new_commit=$NEW_COMMIT" >> $GITHUB_OUTPUT
          
          echo "Comparing: $OLD_COMMIT â†’ $NEW_COMMIT"

      - name: Analyze Provider Model Usage
        run: |
          cd scripts/pipeline/sdk_schema_detection
          
          echo "ðŸ” Analyzing provider model usage..."
          ./analyze_provider_model_usage.py \
            --provider-path ../../../ \
            --output provider_model_usage.json

      - name: Detect OpenAPI Schema Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd scripts/pipeline/graph_openapi_schema_detection
          
          echo "ðŸ” Detecting OpenAPI schema changes..."
          
          CMD="./detect_openapi_changes.py"
          CMD="$CMD --old-commit ${{ steps.commits.outputs.old_commit }}"
          CMD="$CMD --new-commit ${{ steps.commits.outputs.new_commit }}"
          CMD="$CMD --filter-by-usage ../sdk_schema_detection/provider_model_usage.json"
          CMD="$CMD --save-results openapi_changes.json"
          
          if [ "${{ inputs.dry_run }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            CMD="$CMD --dry-run"
          fi
          
          echo "Running: $CMD"
          eval $CMD

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: openapi-detection-results
          path: |
            scripts/pipeline/sdk_schema_detection/provider_model_usage.json
            scripts/pipeline/graph_openapi_schema_detection/openapi_changes.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” OpenAPI Schema Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Old Commit:** \`${{ steps.commits.outputs.old_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**New Commit:** \`${{ steps.commits.outputs.new_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f scripts/pipeline/graph_openapi_schema_detection/openapi_changes.json ]; then
            CHANGES=$(cat scripts/pipeline/graph_openapi_schema_detection/openapi_changes.json | jq -r '.total_schemas_changed // 0')
            BREAKING=$(cat scripts/pipeline/graph_openapi_schema_detection/openapi_changes.json | jq -r '.breaking_changes_count // 0')
            
            echo "**Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Schemas changed: $CHANGES" >> $GITHUB_STEP_SUMMARY
            echo "- Breaking changes: $BREAKING" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$CHANGES" -gt 0 ]; then
              echo "âœ… Changes detected! Check artifacts for details." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No relevant changes detected." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No results file generated." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:** [Download results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
