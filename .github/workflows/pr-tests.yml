name: PR Tests

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    paths:
      - '**/*.go'
      - 'go.mod'
      - 'go.sum'
      - 'pr-checks-config.yml'
      - 'scripts/pipeline/pr/**'

jobs:
  unit-tests:
    name: 'üß™ Unit Tests & Coverage'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60
    outputs:
      has-changes: ${{ steps.run-tests.outputs.has-changes }}
      has-goroutines: ${{ steps.run-tests.outputs.has-goroutines }}
      goroutine-packages: ${{ steps.run-tests.outputs.goroutine-packages }}
      coverage-pct: ${{ steps.run-tests.outputs.coverage-pct }}
      total-lines: ${{ steps.run-tests.outputs.total-lines }}
      covered-lines: ${{ steps.run-tests.outputs.covered-lines }}
      service-domains: ${{ steps.run-tests.outputs.service-domains }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit
          
      - name: Check Out  
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Check if PR is draft
        id: pr-state
        run: |
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "is-draft=true" >> $GITHUB_OUTPUT
            echo "üìù PR is in draft state - tests are informational only"
          else
            echo "is-draft=false" >> $GITHUB_OUTPUT
            echo "‚úÖ PR is ready for review - enforcing coverage threshold"
          fi

      - name: Run unit tests with coverage (generate files)
        id: run-tests-generate
        run: |
          python3 scripts/pipeline/pr/run_pr_tests.py \
            --mode unit-tests \
            --base-ref "origin/${{ github.event.pull_request.base.ref }}" \
            --output-dir coverage \
            ${{ steps.pr-state.outputs.is-draft == 'true' && '--is-draft' || '' }}

      - name: Upload coverage to Codecov
        if: steps.run-tests-generate.outputs.has-changes == 'true'
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/unit-coverage.txt
          flags: unittests,pr-changes
          name: pr-unit-coverage
          fail_ci_if_error: false
      
      - name: Fetch coverage from Codecov and enforce threshold
        id: run-tests
        if: steps.run-tests-generate.outputs.has-changes == 'true'
        run: |
          python3 scripts/pipeline/pr/run_pr_tests.py \
            --mode unit-tests \
            --base-ref "origin/${{ github.event.pull_request.base.ref }}" \
            --output-dir coverage \
            --codecov-token "${{ secrets.CODECOV_TOKEN }}" \
            --repo-slug "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --skip-tests \
            ${{ steps.pr-state.outputs.is-draft == 'true' && '--is-draft' || '' }}

      - name: Comment coverage summary on PR
        if: steps.run-tests.outputs.has-changes == 'true' && steps.run-tests.outputs.coverage-pct != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coveragePct = '${{ steps.run-tests.outputs.coverage-pct }}';
            const totalLines = '${{ steps.run-tests.outputs.total-lines }}';
            const coveredLines = '${{ steps.run-tests.outputs.covered-lines }}';
            const serviceDomains = '${{ steps.run-tests.outputs.service-domains }}';
            const isDraft = '${{ steps.pr-state.outputs.is-draft }}' === 'true';
            const minThreshold = 60;
            
            const passEmoji = parseFloat(coveragePct) >= minThreshold ? '‚úÖ' : '‚ùå';
            const statusText = isDraft 
              ? 'üìù **Draft PR** - Coverage is informational only'
              : parseFloat(coveragePct) >= minThreshold
                ? `${passEmoji} **Coverage Passed** - Meets ${minThreshold}% threshold`
                : `${passEmoji} **Coverage Failed** - Below ${minThreshold}% threshold`;

            const body = `## üìä Unit Test Coverage Report

            ${statusText}

            **Coverage for Changed Packages:** ${coveragePct}%

            - **Total Statements:** ${totalLines}
            - **Covered Statements:** ${coveredLines}
            - **Service Domains:** ${serviceDomains || 'N/A'}

            ${isDraft ? '> üí° Mark PR as ready for review to enforce coverage threshold' : ''}
            ${parseFloat(coveragePct) < minThreshold && !isDraft ? `> ‚ö†Ô∏è  Please add tests to reach ${minThreshold}% coverage` : ''}

            > Note: This is unit test coverage only. Full acceptance test coverage is run bi-weekly and includes integration with Microsoft Graph API.

            [View detailed coverage report on Codecov](https://codecov.io/gh/${{ github.repository }}/pull/${{ github.event.pull_request.number }})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Unit Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  race-detection:
    name: 'üîç Race Detection'
    runs-on: ubuntu-24.04-arm
    needs: unit-tests
    if: |
      needs.unit-tests.outputs.has-goroutines == 'true' &&
      github.event.pull_request.draft == false
    timeout-minutes: 60
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit
          
      - name: Check Out  
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Run race detection
        run: |
          echo "Running race detection on packages with goroutines:"
          echo "${{ needs.unit-tests.outputs.goroutine-packages }}"
          
          python3 scripts/pipeline/pr/run_pr_tests.py \
            --mode race-detection \
            --base-ref "origin/${{ github.event.pull_request.base.ref }}"
