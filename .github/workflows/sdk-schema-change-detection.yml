name: provider | SDK Schema Change Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze (leave empty to use version inputs)'
        required: false
        type: number
      current_version:
        description: 'Current SDK version (e.g., v0.156.0)'
        required: false
        type: string
      new_version:
        description: 'New SDK version (e.g., v0.157.0)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (analyze without creating issues)'
        required: false
        type: boolean
        default: false
      skip_usage_analysis:
        description: 'Skip provider usage analysis (reuse existing results)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  detect-schema-changes:
    name: 'Detect SDK Schema Changes'
    runs-on: ubuntu-24.04-arm
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.actor == 'dependabot[bot]' &&
       contains(github.event.pull_request.title, 'msgraph-beta-sdk-go'))
    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check Out
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.11'

      - name: Verify Python dependencies
        run: |
          echo "Checking Python version..."
          python3 --version
          echo "Checking system dependencies..."
          which gh || echo "gh CLI not found"
          which git || echo "git not found"
          which curl || echo "curl not found"

      - name: Run SDK Schema Change Detection (3-Step Workflow)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd scripts/pipeline/sdk_schema_detection

          # Step 1: Analyze provider model usage
          SKIP_USAGE="${{ inputs.skip_usage_analysis || 'false' }}"
          if [ "$SKIP_USAGE" != "true" ]; then
            echo "ðŸ” Step 1: Analyzing provider model usage..."
            ./analyze_provider_model_usage.py \
              --provider-path ../../../ \
              --output provider_model_usage.json
            echo ""
          fi

          # Step 2: Detect schema changes
          echo "ðŸ” Step 2: Detecting SDK schema changes..."
          CMD="./detect_schema_changes.py"

          # Build command based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            if [ -n "${{ inputs.pr_number }}" ]; then
              CMD="$CMD --pr-number ${{ inputs.pr_number }}"
            elif [ -n "${{ inputs.current_version }}" ] && [ -n "${{ inputs.new_version }}" ]; then
              CMD="$CMD --current ${{ inputs.current_version }} --new ${{ inputs.new_version }}"
            else
              echo "Error: Must provide either pr_number or both current_version and new_version"
              exit 1
            fi

            if [ "${{ inputs.dry_run }}" = "true" ]; then
              CMD="$CMD --dry-run"
            fi
          else
            # PR trigger - use PR number
            CMD="$CMD --pr-number ${{ github.event.pull_request.number }}"
          fi

          # Add usage filtering if analysis was performed
          if [ "$SKIP_USAGE" != "true" ] && [ -f provider_model_usage.json ]; then
            CMD="$CMD --filter-by-usage provider_model_usage.json"
          fi

          # Always save results for artifacts
          CMD="$CMD --save-results schema_changes.json"

          echo "Running: $CMD"
          eval $CMD

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: schema-detection-results
          path: |
            scripts/pipeline/sdk_schema_detection/provider_model_usage.json
            scripts/pipeline/sdk_schema_detection/schema_changes.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment on PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const comment = `## âš ï¸ Action Required: SDK Schema Changes Detected

            This PR updates the Microsoft Graph SDK and includes schema changes that affect provider-managed resources.

            ### ðŸŽ¯ What You Need to Do

            1. **Review the issues** - Check for new issues labeled [\`sdk-update\`](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aopen+label%3Asdk-update)
            2. **Update resource schemas** - Modify Terraform resource/datasource schemas to match SDK changes
            3. **Update CRUD operations** - Adjust field mappings in Create/Read/Update/Delete functions
            4. **Test thoroughly** - Run acceptance tests for affected resources
            5. **Update documentation** - Document any breaking changes or new fields

            ### ðŸ“Š Analysis Results

            - ðŸ“ [View detailed analysis](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) (download \`schema-detection-results\` artifact)
            - ðŸŽ« Issues created only for models actively used by this provider

            âš ï¸ **Do not merge** until all schema changes are addressed and tests pass.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Comment on PR (Failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const comment = `## âŒ Action Required: Schema Detection Failed

            The automated schema change detection failed. **You must run the analysis manually before merging.**

            ### ðŸ”§ Run Analysis Locally

            \`\`\`bash
            cd scripts/pipeline/sdk_schema_detection
            
            # Analyze and detect changes
            ./analyze_provider_model_usage.py --provider-path ../../../ --output provider_model_usage.json
            ./detect_schema_changes.py --pr-number ${{ github.event.pull_request.number }} --filter-by-usage provider_model_usage.json
            \`\`\`

            ### ðŸ“Š Next Steps

            1. Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for error details
            2. Run the analysis locally (commands above)
            3. Review any detected schema changes
            4. Update affected resources/datasources
            5. Re-run CI to verify

            âš ï¸ **Do not merge** without completing schema change analysis.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Summary (Manual Run)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "## ðŸ” SDK Schema Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Workflow Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Step 1:** Provider model usage analysis" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Step 2:** SDK schema change detection" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Step 3:** Intelligent filtering (only relevant models)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "**Analysis Mode:** PR Analysis" >> $GITHUB_STEP_SUMMARY
            echo "**PR Number:** #${{ inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Analysis Mode:** Version Comparison" >> $GITHUB_STEP_SUMMARY
            echo "**Old Version:** ${{ inputs.current_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**New Version:** ${{ inputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Artifacts:** Check the workflow artifacts for detailed JSON results" >> $GITHUB_STEP_SUMMARY
          echo "- \`provider_model_usage.json\` - Models used by the provider" >> $GITHUB_STEP_SUMMARY
          echo "- \`schema_changes.json\` - Detected schema changes (filtered)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the job logs above for detailed analysis results." >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" != "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ« **Next Steps:** Check for new issues with the \`sdk-update\` label" >> $GITHUB_STEP_SUMMARY
            echo "Only issues for provider-managed resources will be created." >> $GITHUB_STEP_SUMMARY
          fi

