name: provider | SDK Schema Change Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze (leave empty to use version inputs)'
        required: false
        type: number
      current_version:
        description: 'Current SDK version (e.g., v0.156.0)'
        required: false
        type: string
      new_version:
        description: 'New SDK version (e.g., v0.157.0)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (analyze without creating issues)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  detect-schema-changes:
    name: 'Detect SDK Schema Changes'
    runs-on: ubuntu-24.04-arm
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.actor == 'dependabot[bot]' &&
       contains(github.event.pull_request.title, 'msgraph-beta-sdk-go'))
    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check Out
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.11'

      - name: Verify Python dependencies
        run: |
          echo "Checking Python version..."
          python3 --version
          echo "Checking system dependencies..."
          which gh || echo "gh CLI not found"
          which git || echo "git not found"
          which curl || echo "curl not found"

      - name: Run SDK Schema Change Detection
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd scripts/pipeline

          # Build command based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            CMD="./kiota_graph_sdk_schema_change_detector.py --repo ${{ github.repository }}"

            if [ -n "${{ inputs.pr_number }}" ]; then
              CMD="$CMD --pr-number ${{ inputs.pr_number }}"
            elif [ -n "${{ inputs.current_version }}" ] && [ -n "${{ inputs.new_version }}" ]; then
              CMD="$CMD --current ${{ inputs.current_version }} --new ${{ inputs.new_version }}"
            else
              echo "Error: Must provide either pr_number or both current_version and new_version"
              exit 1
            fi

            if [ "${{ inputs.dry_run }}" = "true" ]; then
              CMD="$CMD --dry-run"
            fi
          else
            # PR trigger - use PR number
            CMD="./kiota_graph_sdk_schema_change_detector.py --pr-number ${{ github.event.pull_request.number }} --repo ${{ github.repository }}"
          fi

          echo "Running: $CMD"
          eval $CMD

      - name: Comment on PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const comment = `## ðŸ” SDK Schema Change Detection Complete

            The schema change detection analysis has completed successfully.

            **Next Steps:**
            - Check for any new issues created with the \`sdk-update\` label
            - Review identified schema changes
            - Update Terraform resource schemas as needed

            See [SDK Schema Change Detector](https://github.com/${{ github.repository }}/blob/main/scripts/pipeline/kiota_graph_sdk_schema_change_detector.py) for more details.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Comment on PR (Failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const comment = `## âŒ SDK Schema Change Detection Failed

            The schema change detection analysis encountered an error.

            Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            You may need to run the analysis manually:
            \`\`\`bash
            cd scripts/pipeline
            ./kiota_graph_sdk_schema_change_detector.py --pr-number ${{ github.event.pull_request.number }}
            \`\`\``;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Summary (Manual Run)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "## ðŸ” SDK Schema Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "**Analysis Mode:** PR Analysis" >> $GITHUB_STEP_SUMMARY
            echo "**PR Number:** #${{ inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Analysis Mode:** Version Comparison" >> $GITHUB_STEP_SUMMARY
            echo "**Old Version:** ${{ inputs.current_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**New Version:** ${{ inputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the job logs above for detailed analysis results." >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" != "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ« **Next Steps:** Check for new issues with the \`sdk-update\` label" >> $GITHUB_STEP_SUMMARY
          fi
