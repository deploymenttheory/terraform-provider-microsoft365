name: provider | SDK Schema Change Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  detect-schema-changes:
    name: 'Detect SDK Schema Changes'
    runs-on: ubuntu-24.04-arm
    # Only run on Dependabot PRs that update the msgraph-beta-sdk-go
    if: |
      github.actor == 'dependabot[bot]' &&
      contains(github.event.pull_request.title, 'msgraph-beta-sdk-go')
    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check Out
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@49ddb36d9f8f42677f820acbc5c3c218c8186f25 # v6.0.0
        with:
          python-version: '3.11'

      - name: Verify Python dependencies
        run: |
          echo "Checking Python version..."
          python3 --version
          echo "Checking system dependencies..."
          which gh || echo "gh CLI not found"
          which git || echo "git not found"
          which curl || echo "curl not found"

      - name: Run SDK Schema Change Detection
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd scripts/pipeline
          ./kiota_graph_sdk_schema_change_detector.py \
            --pr-number ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }}

      - name: Comment on PR
        if: success()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const comment = `## üîç SDK Schema Change Detection Complete

            The schema change detection analysis has completed successfully.

            **Next Steps:**
            - Check for any new issues created with the \`sdk-update\` label
            - Review identified schema changes
            - Update Terraform resource schemas as needed

            See [SDK Schema Change Detector](https://github.com/${{ github.repository }}/blob/main/scripts/pipeline/kiota_graph_sdk_schema_change_detector.py) for more details.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Comment on PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ùå SDK Schema Change Detection Failed

            The schema change detection analysis encountered an error.

            Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            You may need to run the analysis manually:
            \`\`\`bash
            cd scripts/pipeline
            ./kiota_graph_sdk_schema_change_detector.py --pr-number ${{ github.event.pull_request.number }}
            \`\`\``;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
