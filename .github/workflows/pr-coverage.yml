name: PR Coverage Report

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    paths:
      - '**/*.go'
      - 'go.mod'
      - 'go.sum'

jobs:
  coverage:
    name: 'ðŸ“Š Unit Test Coverage & Codecov'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check Out
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Run PR tests with coverage
        id: run-tests
        run: |
          python3 scripts/pipeline/pr/run_pr_tests.py \
            --mode coverage \
            --base-ref "origin/${{ github.event.pull_request.base.ref }}" \
            --output-dir coverage

      # Upload coverage to Codecov
      - name: Upload unit test coverage
        if: steps.run-tests.outputs.has-changes == 'true'
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/unit-coverage.txt
          flags: unittests,pr-changes
          name: pr-unit-coverage
          fail_ci_if_error: false

      # Comment on PR with coverage summary
      - name: Comment coverage summary on PR
        if: steps.run-tests.outputs.has-changes == 'true' && steps.run-tests.outputs.coverage-pct != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coveragePct = '${{ steps.run-tests.outputs.coverage-pct }}';
            const totalLines = '${{ steps.run-tests.outputs.total-lines }}';
            const coveredLines = '${{ steps.run-tests.outputs.covered-lines }}';
            const serviceAreas = '${{ steps.run-tests.outputs.service-areas }}';

            const body = `## ðŸ“Š Unit Test Coverage Report

            **Coverage for Changed Packages:** ${coveragePct}%

            - **Total Lines:** ${totalLines}
            - **Covered Lines:** ${coveredLines}
            - **Service Areas:** ${serviceAreas || 'N/A'}

            > Note: This is unit test coverage only. Full acceptance test coverage is run bi-weekly and includes integration with Microsoft Graph API.

            [View detailed coverage report on Codecov](https://codecov.io/gh/${{ github.repository }}/pull/${{ github.event.pull_request.number }})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Unit Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
