# Acceptance test: Application Certificate Credential with HEX encoding
# Full dependency chain: random_string -> application -> time_sleep -> certificate_credential

resource "random_string" "test_id_hex" {
  length  = 8
  special = false
  upper   = false
}

# Minimal application for certificate testing
resource "microsoft365_graph_beta_applications_application" "test_app_hex" {
  display_name = "acc-test-app-cert-hex-${random_string.test_id_hex.result}"
  hard_delete  = true

  lifecycle {
    ignore_changes = [key_credentials]
  }
}

# Wait for eventual consistency after application creation
resource "time_sleep" "wait_for_app_hex" {
  depends_on = [microsoft365_graph_beta_applications_application.test_app_hex]

  create_duration = "30s"
}

resource "microsoft365_graph_beta_applications_application_certificate_credential" "test_hex" {
  application_id = microsoft365_graph_beta_applications_application.test_app_hex.id
  display_name   = "acc-test-certificate-hex-${random_string.test_id_hex.result}"

  # Pre-generated hex-encoded certificate (generated with generate_hex_cert.sh)
  key      = "308203c7308202afa003020102021475daa5267c49f47fb56c4ba34bf0a755e23b3739300d06092a864886f70d01010b05003073310b3009060355040613025553310d300b06035504080c0454657374310d300b06035504070c0454657374311a3018060355040a0c1154657374204f7267616e697a6174696f6e312a302806035504030c214167656e74204964656e7469747920426c75657072696e74204865782054657374301e170d3235313230363131353833385a170d3236313230363131353833385a3073310b3009060355040613025553310d300b06035504080c0454657374310d300b06035504070c0454657374311a3018060355040a0c1154657374204f7267616e697a6174696f6e312a302806035504030c214167656e74204964656e7469747920426c75657072696e7420486578205465737430820122300d06092a864886f70d01010105000382010f003082010a0282010100af65b0de8b9fd3df43d3760b5835787e9fefb2fe88c4a2f1906800d58803611bf9868b27b986a00c10b577aea24ada48b4abffab122ed7bd1f7ebcfd25dd714593906a91eff2f32502c9e40623ca06fe65e9155d1bb1557cb6509948ad3774c97d0febfb5e4003d488436d75bafd7fd637cdfc6c16ac7ad66e51ace7a45b85cc1a93b92607219754692444e7b386c083c2f723e834ea30e3914d524aab36f2692b520f24b2a6a1ec7ce8258c5da1ab1ba22dacad47fd6df52196ae174e6295adb360b4fe885a4b2331ad86b8bba6276baddbf4093501a7b6b2e9b6bb9338a3151c6397865e350e62ba8e52a6730d95166a3df327c3abd41348add4d672a52f530203010001a3533051301d0603551d0e041604140b8e901cf0591a555e6389d607f7bb23032e2099301f0603551d230418301680140b8e901cf0591a555e6389d607f7bb23032e2099300f0603551d130101ff040530030101ff300d06092a864886f70d01010b0500038201010053ab67d94e613a7525ebd7798867c1fabdae90baace3b47e9aeca8e93a56a180bae3f5f2573eff6f1f5bdfdab3c73a36cee70ec17266208cd11539da7fc6409c96ca1a25928e0dc5c38be33fa9be02ae6db3ed29551f20be9e9db7d13b97a31350412ef168bfdceec453303c656517c86be3790f5c6fefd2eeeb906031f88852e4c97ff0fb92c4dba3930ab232fd557eb10cb807c32d397d8aeb4b76ef6e5137a82159c0c3ac2a44afc3d69560af883b7e1082dd9b3e7d361d254b9638c4bc77b07cadc2f5e1477c09f15f91fff3cd0df883bf0ade22860fe16487c91f3140bc4b2fa817300689e86a2033fa2a5dc7c6731178f56974255e7b14a51ff623f07f"
  encoding = "hex"
  type     = "AsymmetricX509Cert"
  usage    = "Verify"

  depends_on = [time_sleep.wait_for_app_hex]
}
